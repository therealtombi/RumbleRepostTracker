
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rumble Overlay</title>
    <style>
        body { margin: 0; padding: 20px; overflow: hidden; background: transparent; font-family: sans-serif; }

        #container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 600px;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            border: 2px solid #85c742;

            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #container.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .header {
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .user-name {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .video-title {
            font-size: 18px;
            font-style: italic;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header" class="header"></div>
        <div id="content">
            <div id="user" class="user-name"></div>
            <div id="video" class="video-title"></div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:5050";

        let currentConfigStr = "";
        const audio = new Audio();
        let lastPlayedAudioTime = 0;
        let fadeTimer = null;

        function loadGoogleFont(fontName) {
            if (!fontName) return;
            const linkId = 'google-font-link';
            let link = document.getElementById(linkId);
            if (!link) {
                link = document.createElement('link');
                link.id = linkId;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = `https://fonts.googleapis.com/css?family=${fontName.replace(/ /g, '+')}`;
            document.body.style.fontFamily = `'${fontName}', sans-serif`;
        }

        function fadeOutAudio(duration) {
            const step = 0.05;
            const interval = duration / (1.0 / step);

            const fade = setInterval(() => {
                if (audio.volume > step) {
                    audio.volume -= step;
                } else {
                    audio.volume = 0;
                    audio.pause();
                    audio.currentTime = 0;
                    clearInterval(fade);
                }
            }, interval);
        }

        function update() {
            fetch(API_URL + '/api/data?t=' + new Date().getTime())
                .then(r => r.json())
                .then(resp => {
                    const data = resp.data;
                    const config = resp.config;

                    const container = document.getElementById('container');
                    const headerDiv = document.getElementById('header');
                    const userDiv = document.getElementById('user');
                    const videoDiv = document.getElementById('video');

                    const configStr = JSON.stringify(config);
                    if (configStr !== currentConfigStr) {
                        loadGoogleFont(config.font_family);
                        container.style.textAlign = config.title_align;
                        headerDiv.innerText = config.title_text;
                        headerDiv.style.color = config.title_color;
                        headerDiv.style.fontSize = config.title_size + "px";
                        userDiv.style.color = config.recent_color;
                        videoDiv.style.color = config.older_color;

                        audio.src = API_URL + "/current_sound?t=" + new Date().getTime();
                        audio.load();

                        currentConfigStr = configStr;
                    }

                    if (data.audio_timestamp > lastPlayedAudioTime) {
                        lastPlayedAudioTime = data.audio_timestamp;

                        if(fadeTimer) clearTimeout(fadeTimer);

                        audio.currentTime = 0;
                        audio.volume = 1.0; 

                        var playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                fadeTimer = setTimeout(() => {
                                    fadeOutAudio(2000); 
                                }, 18000);
                            }).catch(error => {
                                console.log("Audio play failed: " + error);
                            });
                        }
                    }

                    if (data.is_visible && data.current_alert) {
                        if (!container.classList.contains('visible') || userDiv.innerText !== data.current_alert.user) {
                            userDiv.innerText = data.current_alert.user;
                            videoDiv.innerText = data.current_alert.video;
                        }
                        container.classList.add('visible');
                    } else {
                        container.classList.remove('visible');
                    }
                })
                .catch(e => { });
        }

        setInterval(update, 500);
    </script>
</body>
</html>
        