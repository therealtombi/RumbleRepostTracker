
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rumble Overlay</title>
    <style>
        /* Base Reset */
        body { margin: 0; padding: 10px; overflow: hidden; background: transparent; font-family: sans-serif; }

        #container {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            font-weight: bold;
            padding-bottom: 5px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            /* Smooth transition for config changes only */
            transition: color 0.5s, font-size 0.5s; 
        }

        .repost-item {
            padding: 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Static opacity - NO PULSING */
            opacity: 1; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Flash Animation Class */
        .flash-active {
            animation: flash 0.5s;
        }

        @keyframes flash {
            0% { background-color: rgba(255,255,255,0); }
            50% { background-color: rgba(255,255,255,0.8); }
            100% { background-color: rgba(255,255,255,0); }
        }

        #error-msg {
            color: red; font-weight: bold; display: none; font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header" class="header"></div>
        <div id="list"></div>
        <div id="error-msg">Connecting to tracker...</div>
    </div>

    <script>
        let currentConfigStr = "";
        let currentDataHash = "";

        function loadGoogleFont(fontName) {
            if (!fontName) return;
            const linkId = 'google-font-link';
            let link = document.getElementById(linkId);
            if (!link) {
                link = document.createElement('link');
                link.id = linkId;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = `https://fonts.googleapis.com/css?family=${fontName.replace(/ /g, '+')}`;
            document.body.style.fontFamily = `'${fontName}', sans-serif`;
        }

        function update() {
            // Timestamp prevents browser caching
            fetch('/api/data?t=' + new Date().getTime())
                .then(r => {
                    if (!r.ok) throw new Error("Not 200 OK");
                    return r.json();
                })
                .then(resp => {
                    document.getElementById('error-msg').style.display = 'none';
                    const data = resp.data;
                    const config = resp.config;

                    const listDiv = document.getElementById('list');
                    const headerDiv = document.getElementById('header');
                    const container = document.getElementById('container');

                    // 1. APPLY STYLES (Only if config changed)
                    const configStr = JSON.stringify(config);
                    if (configStr !== currentConfigStr) {
                        loadGoogleFont(config.font_family);
                        headerDiv.innerText = config.title_text;
                        headerDiv.style.color = config.title_color;
                        headerDiv.style.fontSize = config.title_size + "px";
                        headerDiv.style.textAlign = config.title_align;
                        currentConfigStr = configStr;
                        // Force list redraw to apply new styles to items
                        currentDataHash = "FORCE_REDRAW"; 
                    }

                    // 2. FLASH EFFECT
                    if (data.flash) {
                        container.classList.remove("flash-active");
                        void container.offsetWidth; 
                        container.classList.add("flash-active");
                    }

                    // 3. RENDER DATA
                    const dataHash = JSON.stringify(data.reposts);

                    if (dataHash !== currentDataHash) {
                        currentDataHash = dataHash;

                        if (!data.reposts || data.reposts.length === 0) {
                            listDiv.innerHTML = "";
                            return;
                        }

                        let html = "";
                        data.reposts.forEach((item, index) => {
                            // index 0 is newest
                            const color = (index === 0) ? config.recent_color : config.older_color;
                            const weight = (index === 0) ? "bold" : "normal";

                            html += `
                                <div class="repost-item" style="
                                    font-size: ${config.list_font_size}px; 
                                    text-align: ${config.title_align};
                                    color: ${config.older_color};
                                ">
                                    <span style="color: ${color}; font-weight: ${weight};">â˜… ${item.user}</span> 
                                    reposted!
                                </div>
                            `;
                        });
                        listDiv.innerHTML = html;
                    }
                })
                .catch(e => {
                    // Connection lost (App closed), keep retrying silently
                    console.log("Connection lost, retrying...", e);
                    // Optional: Show disconnected status
                    // document.getElementById('error-msg').style.display = 'block';
                });
        }

        // Poll every 1s
        setInterval(update, 1000);
        update(); // Run immediately
    </script>
</body>
</html>
        